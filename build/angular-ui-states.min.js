/**
 * State-based routing for AngularJS
 * @version v0.0.1 - 2013-02-17
 * @link 
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */
(function(e,t,n){"use strict";function l(e,t){return a(new(a(function(){},{prototype:e})),t)}function c(e){return u(arguments,function(t){t!==e&&u(t,function(t,n){e.hasOwnProperty(n)||(e[n]=t)})}),e}function h(e,t){function r(e){this.locals=e.locals.globals}function o(){this.locals=null}function u(u,a){if(a.redirectTo!=null){var f=a.redirectTo,c;if(s(f))c=f;else{if(!i(f))throw new Error("Invalid 'redirectTo' in when()");c=function(e,t){return f(e,t.path(),t.search())}}t.when(u,c)}else e.state(l(a,{parent:null,name:"route:"+u,url:u,onEnter:r,onExit:o}));return n.push(a),this}function a(e){return l(e,{routes:n})}var n=[];r.$inject=["$$state"],this.when=u,this.$get=a,a.$inject=["$state"]}function p(){function e(e){return e}this.$get=e,e.$inject=["$stateParams"]}function v(e,t){function d(e){var t;if(s(e)){t=h[e];if(!t)throw new Error("No such state '"+e+"'")}else{t=h[e.name];if(!t||t!==e&&t.self!==e)throw new Error("Invalid or unregistered state")}return t}function v(f){f=l(f,{self:f,toString:function(){return this.name}});var c=f.name;if(!s(c))throw new Error("State must have a name");if(h[c])throw new Error("State '"+c+"'' is already defined");var v=n;if(!r(f.parent)){var m=/^(.+)\.[^.]+$/.exec(c);m!=null&&(v=d(m[1]))}else f.parent!=null&&(v=d(f.parent));f.parent=v;var g=f.url;if(s(g))g.charAt(0)=="^"?g=f.url=t.compile(g.substring(1)):g=f.url=v.navigable.url.concat(g);else if(!(o(g)&&i(g.exec)&&i(g.format)&&i(g.concat))&&g!=null)throw new Error("Invalid url '"+g+"' in state '"+f+"'");f.navigable=f.url?f:v?v.navigable:null;var y=f.params=g?g.parameters():f.parent.params,b={};u(y,function(e){b[e]=!0});if(v){u(v.params,function(e){if(!b[e])throw new Error("State '"+c+"' does not define parameter '"+e+"'");b[e]=!1});var w=f.ownParams=[];u(b,function(e,t){e&&w.push(t)})}else f.ownParams=y;var E={};u(r(f.views)?f.views:{"":f},function(e,t){t.indexOf("@")<0&&(t=t+"@"+f.parent.name),E[t]=e}),f.views=E,f.path=v?v.path.concat(f):[];var S=f.includes=v?a({},v.includes):{};return S[c]=!0,f.resolve||(f.resolve={}),!f.abstract&&g&&e.when(g,function(e){p.transitionTo(f,e,!1)}),h[c]=f}function m(e,t){return o(e)?t=e:t.name=e,v(t),this}function g(e,t,i,o,a,h,v){function m(i,s,u){r(u)||(u=!0),i=d(i);if(i.abstract)throw new Error("Cannot transition to abstract state '"+i+"'");var c=i.path,v=p.$current,m=p.params,b=v.path,w,E,S=n.locals,x=[];for(w=0,E=c[w];E&&E===b[w]&&y(s,m,E.ownParams);w++,E=c[w])S=x[w]=E.locals;if(i===v&&S===v.locals)return p.$transition=t.when(p.current);e.$broadcast("$stateChangeStart",i.self,v.self);var T=t.when(S);for(var N=w;N<c.length;N++,E=c[N])S=x[N]=S?l(S):{},T=g(E,s,T,S);var C=p.transition=T.then(function(){var t,n,r;if(p.transition!==C)return;for(t=b.length-1;t>=w;t--)r=b[t],r.self.onExit&&o.invoke(r.self.onExit,r.self,r.locals.globals),r.locals=null;for(t=w;t<c.length;t++)n=c[t],n.locals=x[t],n.self.onEnter&&o.invoke(n.self.onEnter,n.self,n.locals.globals);p.$current=i,p.current=i.self,p.params=S.globals.$stateParams,f(p.params,a);var s=i.navigable;return u&&s&&h.url(s.url.format(s.locals.globals.$stateParams)),e.$broadcast("$stateChangeSuccess",i.self,v.self),p.current},function(n){if(p.transition!==C)return;return e.$broadcast("$stateChangeError",i.self,v.self,n),t.reject(n)});return C}function g(e,n,r,a){function p(e,n){u(e,function(e,r){f.push(t.when(s(e)?o.get(e):o.invoke(e,h)).then(function(e){n[r]=e}))})}var f=[r],l={},h={$stateParams:l};u(e.params,function(e){var t=n[e];l[e]=n[e]!=null?String(t):null});var d=a.globals={$stateParams:l};return p(e.resolve,d),d.$$state=e,u(e.views,function(e,n){var r=a[n]={$$controller:e.controller};f.push(t.when(i.fromConfig(e,l,h)||"").then(function(e){r.$template=e})),p(e.resolve,r)}),t.all(f).then(function(t){return c(a.globals,t[0].globals),u(e.views,function(e,t){c(a[t],a.globals)}),a})}function y(e,t,n){for(var r=0;r<n.length;r++){var i=n[r];if(e[i]!=t[i])return!1}return!0}return p={params:{},current:n.self,$current:n,$transition:t.when(n.self),transitionTo:m,is:function(e){return p.$current===d(e)},includes:function(e){return p.$current.includes[d(e).name]}},p}var n,h={},p;n=v({name:"",url:"^",views:null,"abstract":!0}),n.locals={},this.state=m,this.$get=g,g.$inject=["$rootScope","$q","$templateFactory","$injector","$stateParams","$location","$urlRouter"]}function m(e,t,n){this.fromConfig=function(e,t,n){return r(e.template)?this.fromString(e.template,t):r(e.templateUrl)?this.fromUrl(e.templateUrl,t):r(e.templateProvider)?this.fromProvider(e.templateProvider,t,n):null},this.fromString=function(e,t){return i(e)?e(t):e},this.fromUrl=function(n,r){return i(n)&&(n=n(r)),n==null?null:e.get(n,{cache:t}).then(function(e){return e.data})},this.fromProvider=function(e,t,r){return n.invoke(e,null,r||{params:t})}}function g(e){function f(t){if(!/^\w+$/.test(t))throw new Error("Invalid parameter name '"+t+"' in pattern '"+e+"'");if(n[t])throw new Error("Duplicate parameter name '"+t+"' in pattern '"+e+"'");n[t]=!0,a.push(t)}function l(e){return e.replace(/[\\\[\]\^$*+?.()|{}]/g,"\\$&")}var t=/:(\w+)|\{(\w+)(?:\:((?:[^{}\\]+|\\.|\{(?:[^{}\\]+|\\.)*\})+))?\}/g,n={},r="^",i=0,s,o=this.segments=[],a=this.params=[];this.source=e;var c,h,p;while(s=t.exec(e)){c=s[1]||s[2],h=s[3]||"[^/]*",p=e.substring(i,s.index);if(p.indexOf("?")>=0)break;r+=l(p)+"("+h+")",f(c),o.push(p),i=t.lastIndex}p=e.substring(i);var d=p.indexOf("?");if(d>=0){var v=this.sourceSearch=p.substring(d);p=p.substring(0,d),this.sourcePath=e.substring(0,i+d),u(v.substring(1).split(/[&?]/),f)}else this.sourcePath=e,this.sourceSearch="";r+=l(p)+"$",o.push(p),this.regexp=new RegExp(r),this.prefix=o[0]}function y(){this.compile=function(e){return new g(e)},this.isMatcher=function(e){return e instanceof g},this.$get=function(){return this}}function b(e){function o(e){var t=/^\^((?:\\[^a-zA-Z0-9]|[^\\\[\]\^$*+?.()|{}]+)*)/.exec(e.source);return t!=null?t[1].replace(/\\(.)/g,"$1"):""}function u(e,t){return e.replace(/\$(\$|\d{1,2})/,function(e,n){return t[n==="$"?0:Number(n)]})}function a(e,t,n){if(!n)return!1;var i=t(n,e);return r(i)?i:!0}var t=[],n=null;this.rule=function(e){if(!i(e))throw new Error("'rule' must be a function");return t.push(e),this},this.otherwise=function(e){if(s(e)){var t=e;e=function(){return t}}else if(!i(e))throw new Error("'rule' must be a function");return n=e,this},this.when=function(t,n){var r,f;s(t)&&(t=e.compile(t));if(e.isMatcher(t)){if(s(n))f=e.compile(n),n=function(e){return f.format(e)};else if(!i(n))throw new Error("invalid 'handler' in when()");r=function(e){return a(e,n,t.exec(e.path(),e.search()))},r.prefix=s(t.prefix)?t.prefix:""}else{if(!(t instanceof RegExp))throw new Error("invalid 'what' in when()");if(s(n))f=n,n=function(e){return u(f,e)};else if(!i(n))throw new Error("invalid 'handler' in when()");if(t.global||t.sticky)throw new Error("when() RegExp must not be global or sticky");r=function(e){return a(e,n,t.exec(e.path()))},r.prefix=o(t)}return this.rule(r)},this.$get=["$location","$rootScope",function(e,r){function i(){var n=t.length,r,i;for(r=0;r<n;r++){i=t[r](e);if(i){s(i)&&e.replace().url(i);break}}}return n&&t.push(n),r.$on("$locationChangeSuccess",i),{}}]}function d(e,t,n,r){var i={restrict:"ECA",terminal:!0,link:function(s,o,u){function d(){var i=e.$current&&e.$current.locals[l];if(i===f)return;a&&(a.$destroy(),a=null);if(i){f=i,p.state=i.$$state,o.html(i.$template);var u=t(o.contents());a=s.$new();if(i.$$controller){i.$scope=a;var h=n(i.$$controller,i);o.contents().data("$ngControllerController",h)}u(a),a.$emit("$viewContentLoaded"),a.$eval(c),r()}else f=null,p.state=null,o.html("")}var a,f,l=u[i.name]||u.name||"",c=u.onload||"",h=o.parent().inheritedData("$uiView");l=l+"@"+(h?h.state.name:"");var p={name:l,state:null};o.data("$uiView",p),s.$on("$stateChangeSuccess",d),d()}};return i}var r=t.isDefined,i=t.isFunction,s=t.isString,o=t.isObject,u=t.forEach,a=t.extend,f=t.copy;t.module("ui.util",["ng"]),t.module("ui.router",["ui.util"]),t.module("ui.state",["ui.router","ui.util"]),t.module("ui.compat",["ui.state"]),h.$inject=["$stateProvider","$urlRouterProvider"];var d;t.module("ui.compat").directive("ngView",d).provider("$route",h).provider("$routeParams",p),v.$inject=["$urlRouterProvider","$urlMatcherFactoryProvider"],t.module("ui.state").value("$stateParams",{}).provider("$state",v),m.$inject=["$http","$templateCache","$injector"],t.module("ui.util").service("$templateFactory",m),g.prototype.concat=function(e){return new g(this.sourcePath+e+this.sourceSearch)},g.prototype.toString=function(){return this.source},g.prototype.exec=function(e,t){var n=this.regexp.exec(e);if(!n)return null;var r=this.params,i=r.length,s=this.segments.length-1,o={},u;for(u=0;u<s;u++)o[r[u]]=decodeURIComponent(n[u+1]);for(;u<i;u++)o[r[u]]=t[r[u]];return o},g.prototype.parameters=function(){return this.params},g.prototype.format=function(e){var t=this.segments,n=this.params;if(!e)return t.join("");var r=t.length-1,i=n.length,s=t[0],o,u,a;for(o=0;o<r;o++)a=e[n[o]],a!=null&&(s+=a),s+=t[o+1];for(;o<i;o++)a=e[n[o]],a!=null&&(s+=(u?"&":"?")+n[o]+"="+encodeURIComponent(a),u=!0);return s},t.module("ui.util").provider("$urlMatcherFactory",y),b.$inject=["$urlMatcherFactoryProvider"],t.module("ui.router").provider("$urlRouter",b),d.$inject=["$state","$compile","$controller","$anchorScroll"],t.module("ui.state").directive("uiView",d)})(window,window.angular);